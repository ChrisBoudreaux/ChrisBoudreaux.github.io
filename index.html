<script>
var cellWidth;
var numCells = 25;
var paused = true;
var theGrid;
var theInterval;

//Function iterates through the passed 2D Array and outputs the contents of each
//cell in the grid, line by line
function consoleDebugGrid(grid){
  var x,y,toPrint,maxPrint;
  maxPrint = "";
  for(x = 0; x < grid.length; x++)
  {
    toPrint = "";
    for(y = 0; y < grid[0].length; y++)
    {
      toPrint = toPrint + grid[x][y]+" ";
    }
    maxPrint = maxPrint + toPrint + "\n";
  }
  console.log("debugged Grid: \n"+maxPrint);
}

//Uses the HTML5 Canvas functions to draw a line from the beginning point to the
//given endpoint. Line will have the default width
//Parameters: begin and end - arrays of the format [x,y], where the elements are
// the cartesian coordinates of the start and end pixel
function drawLineFromTo(begin,end) {
  var context = document.getElementById('canvas').getContext('2d');
  context.beginPath();
  context.moveTo(begin[0],begin[1]);
  context.lineTo(end[0],end[1]);
  context.stroke();
}

//Draws a square with side length "width" with its top left corner at (x,y).
//Colorstring specifies the fill color, which should be a CSS color string
function drawSquareAt(x,y,width,colorString)
{
  var context = document.getElementById('canvas').getContext('2d');
  context.beginPath();
  context.rect(x,y,width,width);
  context.fillStyle = colorString;
  context.fill();
}

//Returns true if a cell's value is 0
function cellEmpty(grid, x, y)
{
  //console.log(x+","+y);
  return (grid[x][y] == 0);
}

//Gets the number of non-empty neighbors a cell has without grid wrapping: ie,
// cell (0,0) has only neighbors (0,1),(1,0), and (1,1)
// Returns: the integer number of neighbors the cell has
function getNumberOfNeighborsNoWrap(grid, x, y)
{
  //consoleDebugGrid(grid);
  var i, count;
  count = 0;
  //try {
    if(x > 0 && x < grid.length - 1 && y > 0 && y < grid[0].length - 1)
    {
      if(!cellEmpty(grid,x-1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y+1))
      {
        count++;
      }
    }
    else if(x == 0 && y == 0)
    {
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y+1))
      {
        count++;
      }
    }
    else if(x == 0 && y == grid.length-1)
    {
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
    }
    else if(x == grid.length-1 && y == 0)
    {
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
    }
    else if(x == grid.length-1 && y == grid.length-1)
    {
      if(!cellEmpty(grid,x-1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
    }
    else if(x == 0)
    {
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y+1))
      {
        count++;
      }
    }
    else if(y == 0)
    {
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y+1))
      {
        count++;
      }
    }
    else if(x == grid.length-1)
    {
      if(!cellEmpty(grid,x-1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
    }
    else if(y == grid.length-1)
    {
      if(!cellEmpty(grid,x-1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
    }
    else
    {
      console.log("Oh god?");
    }


  //} catch (e) {
  //  console.log("the grid was less than 3x3");
  //}
  return count;
}

//Gets the number of non-empty neighbors a cell has with grid wrapping: ie,
// cell (0,0) has its top-left neighbor in the bottom-right of the grid
// Returns: the integer number of neighbors the cell has
function getNumberOfNeighborsWithWrap(grid, x, y)
{
  //consoleDebugGrid(grid);
  var i, count;
  count = 0;
  //try {
    if(x > 0 && x < grid.length - 1 && y > 0 && y < grid[0].length - 1)
    {
      if(!cellEmpty(grid,x-1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y+1))
      {
        count++;
      }
    }
    else if(x == 0 && y == 0)
    {
      if(!cellEmpty(grid,grid.length-1,grid[0].length-1))
      {
        count++;
      }
      if(!cellEmpty(grid,grid.length-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,grid.length-1,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,grid[0].length-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,grid[0].length-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y+1))
      {
        count++;
      }
    }
    else if(x == 0 && y == grid.length-1)
    {
      if(!cellEmpty(grid,grid.length-1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,grid.length-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,grid.length-1,0))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,0))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,0))
      {
        count++;
      }
    }
    else if(x == grid.length-1 && y == 0)
    {
      if(!cellEmpty(grid,x-1,grid[0].length-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,grid[0].length-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,0,grid[0].length-1))
      {
        count++;
      }
      if(!cellEmpty(grid,0,y))
      {
        count++;
      }
      if(!cellEmpty(grid,0,y+1))
      {
        count++;
      }
    }
    else if(x == grid.length-1 && y == grid.length-1)
    {
      if(!cellEmpty(grid,x-1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,0))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,0))
      {
        count++;
      }
      if(!cellEmpty(grid,0,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,0,y))
      {
        count++;
      }
      if(!cellEmpty(grid,0,0))
      {
        count++;
      }
    }
    else if(x == 0)
    {
      if(!cellEmpty(grid,grid.length-1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,grid.length-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,grid.length-1,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y+1))
      {
        count++;
      }
    }
    else if(y == 0)
    {
      if(!cellEmpty(grid,x-1,grid[0].length-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,grid[0].length-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,grid[0].length-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y+1))
      {
        count++;
      }
    }
    else if(x == grid.length-1)
    {
      if(!cellEmpty(grid,x-1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y+1))
      {
        count++;
      }
      if(!cellEmpty(grid,0,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,0,y))
      {
        count++;
      }
      if(!cellEmpty(grid,0,y+1))
      {
        count++;
      }
    }
    else if(y == grid.length-1)
    {
      if(!cellEmpty(grid,x-1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x-1,0))
      {
        count++;
      }
      if(!cellEmpty(grid,x,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x,0))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y-1))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,y))
      {
        count++;
      }
      if(!cellEmpty(grid,x+1,0))
      {
        count++;
      }
    }
    else
    {
      console.log("Oh god?");
    }


  //} catch (e) {
  //  console.log("the grid was less than 3x3");
  //}
  return count;
}

//Returns 0 if a cell should die, or 1 if a cell should live or come to life in
//accordance with the rules of Conway's Game of life:
//For more reading - https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life
function GOLRule(grid, x, y)
{
  var neighbors = getNumberOfNeighborsWithWrap(grid,x,y);
  //console.log("grid["+x+"]["+y+"] numNeighbors= "+ neighbors);
  switch(neighbors)
  {
    case 0:
    case 1:
      return 0;
      break;
    case 2:
      if(cellEmpty(grid, x, y)) return 0;
    case 3:
      return 1;
      break;
    case 4:
    case 5:
    case 6:
    case 7:
    case 8:
      return 0;
      break;
    default:
      break;
  }
  throw "GOL RULE FAILED";
}

//Applies the given rule to each cell of the grid and returns the next iteration
//of the grid.
//Parameters: grid- a rectangular 2D array
//            rule - a function of 3 parameters, a grid, and x and y (integers)
function evolve(grid, rule)
{
  var i,x,y,tempGrid;

  //We need to make tempGrid a 2D array the same dimensions as grid
  tempGrid = new Array(grid.length);
  for(x = 0; x < grid.length; x++)
  {
    tempGrid[x] = new Array(grid[0].length);
    for(y = 0; y < grid[0].length; y++)
    {
      tempGrid[x][y] = 0;
    }
  }

 //apply the rule to each item of the cells in the grid
  for(x = 0; x < grid.length; x++)
  {
    for(y = 0; y < grid[0].length; y++)
    {
      tempGrid[x][y] = rule(grid,x,y);
    }
  }

  return tempGrid;
}

//Initializes the grid to its initial configuration, and pauses the game
function init() {
  var i,j;
  numCells = Math.floor(numCells);
  paused = true;
  cellWidth = Math.floor(300 / numCells);
  theGrid =    new Array(numCells);
  for(i = 0; i < numCells; i++)
  {
    theGrid[i] = new Array(numCells);
    for(j = 0; j < numCells; j++)
    {
      theGrid[i][j] = Math.floor((Math.random()*2));
    }
  }
  window.requestAnimationFrame(draw);
  drawSquareAt(0,0,300,"white");


}
//Renders the currently-stored grid
function draw() {
  var grid = theGrid;
  var x,y;
  //draw the filled in cells
  for(x = 0; x < numCells; x++)
  {
    for(y = 0; y < numCells; y++)
    {
      if(grid[x][y] != 0)
      {
        drawSquareAt(x*cellWidth,y*cellWidth,cellWidth,'blue');
      }
      else
      {
        drawSquareAt(x*cellWidth,y*cellWidth,cellWidth,'white');
      }
    }
  }
  //Draw gridlines
  for(x = 0; x <= numCells * cellWidth; x += cellWidth)
  {
    drawLineFromTo([x,0],[x,numCells * cellWidth]);
  }
  for(y = 0; y <= numCells * cellWidth; y += cellWidth)
  {
    drawLineFromTo([0,y],[numCells * cellWidth,y]);
  }

}

//Click Handler for the Play / Pause button. Starts a 100 ms interval for
// drawing the grid and evolving it
function pauseToggle()
{
  if(paused)
  {
    console.log("Unpausing");
    paused = false;
    theInterval = window.setInterval(function()
    {
      window.requestAnimationFrame(draw);
      theGrid = evolve(theGrid, GOLRule);
    },100);
  }
  else {
      window.clearInterval(theInterval);
      console.log("Pausing");
      paused = true;
      window.clearInterval(theInterval);
  }
}

//Reinitializes the grid to its original state and redraws
function reset()
{
  window.clearInterval(theInterval);
  var userValue = document.getElementById("numCells").value;
  console.log(userValue);
  if( userValue != "")
  {
    if(userValue < 5)
    {
      alert("5 is the minimum");
      numCells = 5;
    }
    else if (userValue > 100) {
      alert("100 is the maximum");
      numCells = 100;
    }
    else {
      numCells = userValue;
    }
  }
  init();
  window.requestAnimationFrame(draw);
}

init();
</script>
<head>
  <title>A Developing Journey into Web Development</title>
</head>
<body>
  <h1>2D Cellular Automata</h1>
  <canvas id="canvas" width="300" height="300"></canvas></br>
  Number of Cells Wide: <input id = "numCells" type="number" min-"3" /> </br>
<button type="button" value="paused" onclick="pauseToggle()">PLAY / PAUSE</button>
<button type="button" onclick="reset()"> NEW GRID </button></br><hr>
  <p>
    This simple HTML Canvas currently simulates Conway's game of life for a
    random grid. Coming soon are:
  </p>
  <ul>
    <li>User-specified starting patterns</li>
    <li>Resizability of the grid</li>
    <li>Support for other 2D Cellular Automata</li>
    <li>Better page design</li>
    <li>More content and similar projects</li>
  </ul>
</br><hr>
<h6>Chris Boudreaux, 2016</h6>
</body>
